name: release
on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    prebuild-native:
        strategy:
            matrix:
                include:
                    - os: windows-latest
                      platform: win32-x64
                    - os: ubuntu-latest
                      platform: linux-x64
        runs-on: ${{ matrix.os }}
        steps:
            - name: checkout
              uses: actions/checkout@v6
              with:
                  submodules: true

            - name: install system dependencies (ubuntu)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential cmake ninja-build

            - name: install system dependencies (windows)
              if: runner.os == 'Windows'
              run: choco install ninja

            - name: setup MSVC environment
              if: runner.os == 'Windows'
              uses: ilammy/msvc-dev-cmd@v1

            - name: Install LLVM and Clang
              uses: KyleMayes/install-llvm-action@v2
              with:
                  version: "20.1.0"

            - name: setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "22"

            - name: setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: install dependencies
              run: bun install

            - name: build native
              run: bun run compile:native

            - name: prepare prebuilds
              shell: bash
              run: |
                  mkdir -p prebuilds/${{ matrix.platform }}
                  cp build/osu-beatmap-parser.node prebuilds/${{ matrix.platform }}/

            - name: upload prebuild artifacts
              uses: actions/upload-artifact@v5
              with:
                  name: prebuilds-${{ matrix.platform }}
                  path: prebuilds/${{ matrix.platform }}/
                  retention-days: 7

    prebuild-wasm:
        runs-on: ubuntu-latest
        steps:
            - name: checkout
              uses: actions/checkout@v6
              with:
                  submodules: true

            - name: setup emscripten
              uses: mymindstorm/setup-emsdk@v14
              with:
                  version: "latest"

            - name: setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "22"

            - name: setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: install dependencies
              run: bun install

            - name: build wasm
              run: bun run compile:wasm

            - name: upload wasm artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: wasm-build
                  path: |
                      build/osu-parser.browser.js
                      build/osu-beatmap-parser.js
                  retention-days: 7

    release:
        needs: [prebuild-native, prebuild-wasm]
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: download native artifacts
              uses: actions/download-artifact@v5
              with:
                  path: artifacts

            - name: prepare release assets
              run: |
                  mkdir -p release-assets

                  # native prebuilds
                  if [ -d "artifacts/prebuilds-win32-x64" ]; then
                      cp artifacts/prebuilds-win32-x64/osu-beatmap-parser.node release-assets/osu-beatmap-parser-win32-x64.node
                  fi
                  if [ -d "artifacts/prebuilds-linux-x64" ]; then
                      cp artifacts/prebuilds-linux-x64/osu-beatmap-parser.node release-assets/osu-beatmap-parser-linux-x64.node
                  fi

                  # wasm builds (bundled + raw emscripten)
                  if [ -d "artifacts/wasm-build" ]; then
                      cp artifacts/wasm-build/osu-parser.browser.js release-assets/ || true
                      cp artifacts/wasm-build/osu-beatmap-parser.js release-assets/ || true
                  fi

                  ls -la release-assets/

            - name: create github release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  TAG_NAME=${GITHUB_REF#refs/tags/}

                  # create release with assets
                  gh release create "$TAG_NAME" \
                    --repo="$GITHUB_REPOSITORY" \
                    --title="$TAG_NAME" \
                    --generate-notes \
                    release-assets/*

    publish:
        needs: [prebuild-native, prebuild-wasm]
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "22"
                  registry-url: "https://registry.npmjs.org"

            - name: setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: install dependencies
              run: bun install --ignore-scripts

            - name: download prebuilds
              uses: actions/download-artifact@v5
              with:
                  path: prebuilds-tmp

            - name: organize prebuilds
              run: |
                  mkdir -p prebuilds/win32-x64 prebuilds/linux-x64

                  # copy native prebuilds only (no wasm for npm)
                  if [ -d "prebuilds-tmp/prebuilds-win32-x64" ]; then
                      cp prebuilds-tmp/prebuilds-win32-x64/* prebuilds/win32-x64/
                  fi
                  
                  if [ -d "prebuilds-tmp/prebuilds-linux-x64" ]; then
                      cp prebuilds-tmp/prebuilds-linux-x64/* prebuilds/linux-x64/
                  fi

                  echo "prebuilds structure:"
                  find prebuilds -type f

            - name: build typescript
              run: bun run compile:tsc

            - name: publish to npm
              run: npm publish --provenance --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
